"use strict";var _createClass=function(){function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var DBHelper=function(){function o(){_classCallCheck(this,o)}return _createClass(o,null,[{key:"createDatabase",value:function(){return idb.open("restaurants",2,function(t){switch(t.oldVersion){case 0:case 1:console.log("Creating the restaurants object store"),t.createObjectStore("restaurants",{keyPath:"id"});case 2:console.log("Creating the reviews object store"),t.createObjectStore("reviews",{keyPath:"id"})}})}},{key:"addRestaurantsToDB",value:function(r){return o.createDatabase().then(function(t){if(t){var e=t.transaction("restaurants","readwrite").objectStore("restaurants");return Promise.all(r.map(function(t){return console.log("adding restaurants to database"),e.put(t)}))}}).catch(function(t){tx.abort(),console.error(t)})}},{key:"fetchRestaurantsFromDB",value:function(){return o.createDatabase().then(function(t){return t.transaction("restaurants","readonly").objectStore("restaurants").getAll()})}},{key:"addReviewsToDB",value:function(r){return o.createDatabase().then(function(t){if(t){var e=t.transaction("reviews","readwrite").objectStore("reviews");return Promise.all(r.map(function(t){return console.log("adding reviews to database"),e.put(t)}))}}).catch(function(t){tx.abort(),console.error(t)})}},{key:"fetchReviewsFromDB",value:function(){return o.createDatabase().then(function(t){return t.transaction("reviews","readonly").objectStore("reviews").getAll()})}},{key:"updateFavouriteStatusinDB",value:function(e,r){return o.createDatabase().then(function(t){return o.getRestaurantFromDB(t,e)}).then(function(t){return o.setFavouriteStatus(t,r)}).then(function(t){return o.addFavoriteStatustoDB(t)}).catch(o.logError)}},{key:"getRestaurantFromDB",value:function(t,e){return t.transaction("restaurants","readwrite").objectStore("restaurants").get(e)}},{key:"setFavouriteStatus",value:function(n,a){return new Promise(function(t,e){var r=n;r.is_favorite=a,t(r)})}},{key:"addFavoriteStatustoDB",value:function(e){return o.createDatabase().then(function(t){return t.transaction("restaurants","readwrite").objectStore("restaurants").put(e)}).catch(o.logError)}},{key:"logError",value:function(t){console.error(t)}},{key:"validateJSON",value:function(t){if(!t.ok)throw Error(t.statusText);return t.json()}},{key:"defineRestaurants",value:function(t){var e=t;return console.log("Network contact"),e}},{key:"fetchRestaurantsFromNetwork",value:function(){return fetch(o.DATABASE_URL+"/restaurants").then(o.validateJSON).then(o.defineRestaurants)}},{key:"fetchRestaurants",value:function(){return o.fetchRestaurantsFromDB().then(function(t){return 0===t.length?o.fetchRestaurantsFromNetwork().then(function(t){return o.addRestaurantsToDB(t),t}).catch(o.logError):t})}},{key:"fetchReviewsByIdFromNetwork",value:function(t){return fetch(o.DATABASE_URL+"/reviews/?restaurant_id="+t).then(o.validateJSON).then(function(t){return t})}},{key:"fetchReviewsById",value:function(e){return o.fetchReviewsFromDB().then(function(t){return 0===t.length?o.fetchReviewsByIdFromNetwork(e).then(function(t){return o.addReviewsToDB(t),t}).catch(o.logError):t})}},{key:"fetchRestaurantById",value:function(t){return fetch(o.DATABASE_URL+"/restaurants/"+t).then(o.validateJSON).then(function(t){return t})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(r,n){return o.fetchRestaurants().then(function(t){var e=t;return"all"!=r&&(e=e.filter(function(t){return t.cuisine_type==r})),"all"!=n&&(e=e.filter(function(t){return t.neighborhood==n})),e})}},{key:"fetchNeighborhoods",value:function(){return o.fetchRestaurants().then(function(r){var n=r.map(function(t,e){return r[e].neighborhood});return n.filter(function(t,e){return n.indexOf(t)==e})})}},{key:"fetchCuisines",value:function(){return o.fetchRestaurants().then(function(r){var n=r.map(function(t,e){return r[e].cuisine_type});return n.filter(function(t,e){return n.indexOf(t)==e})})}},{key:"urlForRestaurant",value:function(t){return"./restaurant.html?id="+t.id}},{key:"imageUrlForRestaurant",value:function(t){return"img/"+t.id+"-600.jpg"}},{key:"srcsetForRestaurant",value:function(t){return"img/webp/"+t.id+"-400.webp 400w,\n      img/webp/"+t.id+"-600.webp 600w,\n      img/webp/"+t.id+"-800.webp 800w"}},{key:"addFavoriteStatus",value:function(t,e){return fetch("http://localhost:1337/restaurants/"+t+"/?is_favorite="+e,{method:"PUT"}).then(o.validateJSON).then(function(t){var e=t.is_favorite,r=t.id;o.updateFavouriteStatusinDB(r,e)}).catch(function(t){return console.error("Error:",t)})}},{key:"toggleButtonState",value:function(){document.addEventListener("click",o.updateButtonState,!1)}},{key:"updateButtonState",value:function(t){if(t.target.dataset.action&&"save"===t.target.dataset.action){var e=t.target,r=e.dataset.restaurantId;console.log(r);var n="true",a="Remove from favourites";"true"===e.getAttribute("aria-pressed")&&(n="false",a="Add to favourites"),e.setAttribute("aria-pressed",n),e.setAttribute("aria-label",a),o.addFavoriteStatus(r,n)}}},{key:"postReviewtoServer",value:function(t){var e=o.DATABASE_URL+"/reviews",r={method:"POST",body:JSON.stringify(t)};fetch(e,r).then(o.validateJSON).then(function(t){return t})}},{key:"addScript",value:function(){var t=document.body,e=document.createElement("script");e.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCSQXjgi1K6hqDS4W3nWVK_z0lntlbLFPo&libraries=places&callback=initMap",t.appendChild(e)}},{key:"toggleMap",value:function(t,e){var r=document.getElementById(t),n=document.getElementById(e);r.addEventListener("click",function(t){t.preventDefault(),n&&(n.classList.toggle("is-visible"),window.google||o.addScript())},!1)}},{key:"mapMarkerForRestaurant",value:function(t,e){return new google.maps.Marker({position:t.latlng,title:t.name,url:o.urlForRestaurant(t),map:e,animation:google.maps.Animation.DROP})}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337"}}]),o}();
//# sourceMappingURL=dbhelper.js.map
