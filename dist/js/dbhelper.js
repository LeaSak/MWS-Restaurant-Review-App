"use strict";var _createClass=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var DBHelper=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"createDatabase",value:function(){return idb.open("restaurants",2,function(e){switch(e.oldVersion){case 0:case 1:console.log("Creating the restaurants object store"),e.createObjectStore("restaurants",{keyPath:"id"});case 2:console.log("Creating the reviews object store"),e.createObjectStore("reviews",{keyPath:"id"})}})}},{key:"addRestaurantsToDB",value:function(r){return a.createDatabase().then(function(e){if(e){var t=e.transaction("restaurants","readwrite").objectStore("restaurants");return Promise.all(r.map(function(e){return console.log("adding restaurants to database"),t.put(e)}))}}).catch(function(e){tx.abort(),console.error(e)})}},{key:"fetchRestaurantsFromDB",value:function(){return a.createDatabase().then(function(e){return e.transaction("restaurants","readonly").objectStore("restaurants").getAll()})}},{key:"addReviewsToDB",value:function(r){return a.createDatabase().then(function(e){if(e){var t=e.transaction("reviews","readwrite").objectStore("reviews");return Promise.all(r.map(function(e){return console.log("adding reviews to database"),t.put(e)}))}}).catch(function(e){tx.abort(),console.error(e)})}},{key:"fetchReviewsFromDB",value:function(){return a.createDatabase().then(function(e){return e.transaction("reviews","readonly").objectStore("reviews").getAll()})}},{key:"updateFavouriteStatusinDB",value:function(t,r){return a.createDatabase().then(function(e){return a.getRestaurantFromDB(e,t)}).then(function(e){return a.setFavouriteStatus(e,r)}).then(function(e){return a.addFavoriteStatustoDB(e)}).catch(a.logError)}},{key:"getRestaurantFromDB",value:function(e,t){return e.transaction("restaurants","readwrite").objectStore("restaurants").get(t)}},{key:"setFavouriteStatus",value:function(n,a){return new Promise(function(e,t){var r=n;r.is_favorite=a,e(r)})}},{key:"addFavoriteStatustoDB",value:function(t){return a.createDatabase().then(function(e){return e.transaction("restaurants","readwrite").objectStore("restaurants").put(t)}).catch(a.logError)}},{key:"logError",value:function(e){console.error(e)}},{key:"validateJSON",value:function(e){if(!e.ok)throw Error(e.statusText);return e.json()}},{key:"defineRestaurants",value:function(e){return e}},{key:"fetchRestaurantsFromNetwork",value:function(){return fetch(a.DATABASE_URL+"/restaurants").then(a.validateJSON).then(a.defineRestaurants)}},{key:"fetchRestaurants",value:function(){return a.fetchRestaurantsFromDB().then(function(e){return 0===e.length?a.fetchRestaurantsFromNetwork().then(function(e){return a.addRestaurantsToDB(e),e}).catch(a.logError):e})}},{key:"fetchReviewsByIdFromNetwork",value:function(e){return fetch(a.DATABASE_URL+"/reviews/?restaurant_id="+e).then(a.validateJSON).then(function(e){return e})}},{key:"fetchReviewsById",value:function(t){return a.fetchReviewsFromDB().then(function(e){return 0===e.length?a.fetchReviewsByIdFromNetwork(t).then(function(e){return a.addReviewsToDB(e),e}).catch(a.logError):e})}},{key:"fetchRestaurantById",value:function(e){return fetch(a.DATABASE_URL+"/restaurants/"+e).then(a.validateJSON).then(function(e){return e})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(r,n){return a.fetchRestaurants().then(function(e){var t=e;return"all"!=r&&(t=t.filter(function(e){return e.cuisine_type==r})),"all"!=n&&(t=t.filter(function(e){return e.neighborhood==n})),t})}},{key:"fetchNeighborhoods",value:function(){return a.fetchRestaurants().then(function(r){var n=r.map(function(e,t){return r[t].neighborhood});return n.filter(function(e,t){return n.indexOf(e)==t})})}},{key:"fetchCuisines",value:function(){return a.fetchRestaurants().then(function(r){var n=r.map(function(e,t){return r[t].cuisine_type});return n.filter(function(e,t){return n.indexOf(e)==t})})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return"img/"+e.id+"-600.jpg"}},{key:"srcsetForRestaurant",value:function(e){return"img/webp/"+e.id+"-400.webp 400w,\n      img/webp/"+e.id+"-600.webp 600w,\n      img/webp/"+e.id+"-800.webp 800w"}},{key:"addFavoriteStatus",value:function(e,t){return fetch("http://localhost:1337/restaurants/"+e+"/?is_favorite="+t,{method:"PUT"}).then(a.validateJSON).then(function(e){var t=e.is_favorite,r=e.id;a.updateFavouriteStatusinDB(r,t)}).catch(function(e){return console.error("Error:",e)})}},{key:"addScript",value:function(){var e=document.body,t=document.createElement("script");t.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCSQXjgi1K6hqDS4W3nWVK_z0lntlbLFPo&libraries=places&callback=initMap",e.appendChild(t)}},{key:"toggleMap",value:function(e,t){var r=document.getElementById(e),n=document.getElementById(t);r.addEventListener("click",function(e){e.preventDefault(),n&&(n.classList.toggle("is-visible"),window.google||a.addScript())},!1)}},{key:"mapMarkerForRestaurant",value:function(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:a.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337"}}]),a}();
//# sourceMappingURL=dbhelper.js.map
