"use strict";var _createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var DBHelper=function(){function o(){_classCallCheck(this,o)}return _createClass(o,null,[{key:"createDatabase",value:function(){return idb.open("restaurants",2,function(e){switch(e.oldVersion){case 0:case 1:console.log("Creating the restaurants object store"),e.createObjectStore("restaurants",{keyPath:"id"});case 2:console.log("Creating the reviews object store"),e.createObjectStore("reviews",{keyPath:"id"});case 3:console.log("Creating the pending reviews object store"),e.createObjectStore("pending_reviews",{keyPath:"id"})}})}},{key:"addRestaurantsToDB",value:function(n){return o.createDatabase().then(function(e){if(e){var t=e.transaction("restaurants","readwrite").objectStore("restaurants");return Promise.all(n.map(function(e){return console.log("adding restaurants to database"),t.put(e)}))}}).catch(function(e){tx.abort(),console.error(e)})}},{key:"fetchRestaurantsFromDB",value:function(){return o.createDatabase().then(function(e){return e.transaction("restaurants","readonly").objectStore("restaurants").getAll()})}},{key:"addReviewsToDB",value:function(n){return o.createDatabase().then(function(e){if(e){var t=e.transaction("reviews","readwrite").objectStore("reviews");return Promise.all(n.map(function(e){return console.log("adding reviews to database"),t.put(e)}))}}).catch(function(e){tx.abort(),console.error(e)})}},{key:"fetchReviewsFromDB",value:function(){return o.createDatabase().then(function(e){return e.transaction("reviews","readonly").objectStore("reviews").getAll()})}},{key:"updateLocalFavouriteStatus",value:function(t){return o.createDatabase().then(function(e){return e.transaction("restaurants","readwrite").objectStore("restaurants").put(t)})}},{key:"logError",value:function(e){console.error(e)}},{key:"validateJSON",value:function(e){if(!e.ok)throw Error(e.statusText);return e.json()}},{key:"defineRestaurants",value:function(e){var t=e;return console.log("Network contact"),t}},{key:"fetchRestaurantsFromNetwork",value:function(){return fetch(o.DATABASE_URL+"/restaurants").then(o.validateJSON).then(o.defineRestaurants)}},{key:"fetchRestaurants",value:function(){return o.fetchRestaurantsFromDB().then(function(e){return 0===e.length?o.fetchRestaurantsFromNetwork().then(function(e){return o.addRestaurantsToDB(e),e}).catch(o.logError):e})}},{key:"fetchReviewsByIdFromNetwork",value:function(e){return fetch(o.DATABASE_URL+"/reviews/?restaurant_id="+e).then(o.validateJSON).then(function(e){return e})}},{key:"fetchReviewsById",value:function(t){return o.fetchReviewsFromDB().then(function(e){return 0===e.length?o.fetchReviewsByIdFromNetwork(t).then(function(e){return o.addReviewsToDB(e),e}).catch(o.logError):e})}},{key:"fetchRestaurantById",value:function(e){return fetch(o.DATABASE_URL+"/restaurants/"+e).then(o.validateJSON).then(function(e){return e})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(n,r){return o.fetchRestaurants().then(function(e){var t=e;return"all"!=n&&(t=t.filter(function(e){return e.cuisine_type==n})),"all"!=r&&(t=t.filter(function(e){return e.neighborhood==r})),t})}},{key:"fetchNeighborhoods",value:function(){return o.fetchRestaurants().then(function(n){var r=n.map(function(e,t){return n[t].neighborhood});return r.filter(function(e,t){return r.indexOf(e)==t})})}},{key:"fetchCuisines",value:function(){return o.fetchRestaurants().then(function(n){var r=n.map(function(e,t){return n[t].cuisine_type});return r.filter(function(e,t){return r.indexOf(e)==t})})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return"img/"+e.id+"-600.jpg"}},{key:"srcsetForRestaurant",value:function(e){return"img/webp/"+e.id+"-400.webp 400w,\n      img/webp/"+e.id+"-600.webp 600w,\n      img/webp/"+e.id+"-800.webp 800w"}},{key:"addFavoriteStatus",value:function(e,t){return fetch("http://localhost:1337/restaurants/"+e+"/?is_favorite="+t,{method:"PUT"}).then(o.validateJSON).then(function(e){console.log("put request result",e),o.updateLocalFavouriteStatus(e)}).catch(function(e){return console.error("Error:",e)})}},{key:"toggleButtonState",value:function(){document.addEventListener("click",o.updateButtonState,!1)}},{key:"updateButtonState",value:function(e){if(e.target.dataset.action&&"save"===e.target.dataset.action){var t=e.target,n=t.dataset.restaurantId;console.log(n);var r="true",a="Remove from favourites";"true"===t.getAttribute("aria-pressed")&&(r="false",a="Add to favourites"),t.setAttribute("aria-pressed",r),t.setAttribute("aria-label",a),o.addFavoriteStatus(n,r)}}},{key:"submitPendingReview",value:function(e){o.postReviewtoServer(e).catch(function(){o.sendSyncRequest(e)})}},{key:"sendSyncRequest",value:function(e){navigator.serviceWorker&&(console.log("send sync request"),o.submitReviewtoDB(e),navigator.serviceWorker.ready.then(function(e){return e.sync.register("review-sync")}))}},{key:"postReviewtoServer",value:function(e){var t=o.DATABASE_URL+"/reviews",n={method:"POST",body:JSON.stringify(e)};return fetch(t,n)}},{key:"submitReviewtoDB",value:function(t){return o.createDatabase().then(function(e){if(e)return e.transaction("pending_reviews","readwrite").objectStore("pending_reviews").put(t),t})}},{key:"fetchPendingReviewsFromDB",value:function(){return o.createDatabase().then(function(e){if(e)return e.transaction("pending_reviews","readonly").objectStore("pending_reviews").getAll()}).then(function(e){var t=e||[];return Promise.all(t.map(function(e){return console.log("post each review to server"),o.postReviewtoServer(e)}))}).then(o.clearPendingReviews).catch(function(e){return console.log(e)})}},{key:"clearPendingReviews",value:function(){return o.createDatabase().then(function(e){if(e){var t=e.transaction("pending_reviews","readwrite");return t.objectStore("pending_reviews").clear(),console.log("pending review store cleared"),t.complete}})}},{key:"addScript",value:function(){var e=document.body,t=document.createElement("script");t.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCSQXjgi1K6hqDS4W3nWVK_z0lntlbLFPo&libraries=places&callback=initMap",e.appendChild(t)}},{key:"toggleMap",value:function(e,t){var n=document.getElementById(e),r=document.getElementById(t);n.addEventListener("click",function(e){e.preventDefault(),r&&(r.classList.toggle("is-visible"),window.google||o.addScript())},!1)}},{key:"mapMarkerForRestaurant",value:function(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:o.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337"}}]),o}();
//# sourceMappingURL=dbhelper.js.map
